#!/usr/bin/with-contenv bash
# shellcheck shell=bash

export CPU_CORES="${CPU_CORES:=$(/app/immich/server/scripts/get-cpus.sh)}"
export IMMICH_HOST="${SERVER_HOST:-"0.0.0.0"}"
export IMMICH_PORT="${SERVER_PORT:-"8080"}"

echo "Detected CPU Cores: $CPU_CORES"
if [ "$CPU_CORES" -gt 4 ]; then
  export UV_THREADPOOL_SIZE=$CPU_CORES
fi

exec \
    s6-notifyoncheck -d -n 300 -w 5000 -c "nc -z ${IMMICH_HOST} ${IMMICH_PORT}" \
        cd /app/immich/server s6-setuidgid abc \
            node dist/main
